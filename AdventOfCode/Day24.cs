using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;

namespace AdventOfCode
{
    class Day24
    {
        private static Dictionary<(int x, int y), char> _map;
        private static Dictionary<int, (int x, int y)> _locationByNum;
        private static int _width;
        private static int _height;

        public void DoItA()
        {
            CreateMap(Data);

            int record = int.MaxValue;
            List<int> fastestOrder = null;
            int i = 0;
            foreach (var order in GetAllOrders(_locationByNum.Keys.Except(new[]{0}).ToList()))
            {
                Console.WriteLine(i++);
                
                var node = new Node();
                var (startX, startY) = _locationByNum[0];
                node.X = startX;
                node.Y = startY;
                node.Steps = 0;

                foreach (var dest in order)
                {
                    node = MoveFastestTo(node, _locationByNum[dest]);
                    if (node.Steps > record)
                        break;
                }
                
                //Console.WriteLine(string.Join(", ", order) + $" took {node.Steps} steps");

                if (node.Steps < record)
                {
                    record = node.Steps;
                    fastestOrder = order;
                }
            }
            
            Console.WriteLine($"Fastest way is {record} steps ({string.Join(", ", fastestOrder!)})");
        }

        public void DoItB()
        {
            CreateMap(Data);

            int record = int.MaxValue;
            List<int> fastestOrder = null;
            foreach (var order in GetAllOrders(_locationByNum.Keys.Except(new[]{0}).ToList()))
            {
                var node = new Node();
                var (startX, startY) = _locationByNum[0];
                node.X = startX;
                node.Y = startY;
                node.Steps = 0;

                foreach (var dest in order)
                {
                    node = MoveFastestTo(node, _locationByNum[dest]);
                    if (node.Steps > record)
                        break;
                }

                node = MoveFastestTo(node, _locationByNum[0]);
                
                if (node.Steps < record)
                {
                    record = node.Steps;
                    fastestOrder = order;
                }
            }
            
            Console.WriteLine($"Fastest way is {record} steps ({string.Join(", ", fastestOrder!)})");
        }

        private static IEnumerable<List<int>> GetAllOrders(IReadOnlyList<int> values)
        {
            if (values.Count == 0)
                yield break;
            if (values.Count == 1)
            {
                yield return new List<int> { values[0] };
                yield break;
            }
            
            for (int i = 0; i < values.Count; i++)
            {
                var rest = new List<int>(values);
                rest.RemoveAt(i);
                
                foreach (var o in GetAllOrders(rest))
                {
                    var order = new List<int>();
                    order.Add(values[i]);
                    order.AddRange(o);
                    yield return order;
                }
            }
        }

        private static void CreateMap(string test)
        {
            _map = new Dictionary<(int x, int y), char>();
            _locationByNum = new Dictionary<int, (int x, int y)>();

            int y = 0;

            var streamReader = new StreamReader(new MemoryStream(Encoding.UTF8.GetBytes(test)));
            while (true)
            {
                var line = streamReader.ReadLine();
                if (string.IsNullOrEmpty(line))
                    break;

                _width = line.Length;

                int x = 0;
                foreach (var chr in line)
                {
                    var coord = (x++, y);
                    _map[coord] = chr;
                    if (char.IsDigit(chr))
                    {
                        var loc = chr - '0';
                        _locationByNum[loc] = coord;
                    }
                }

                y++;
            }

            _height = y;
        }

        private Dictionary<(int startX, int startY, int stopX, int stopY), int> _movementCost = new();

        private Node MoveFastestTo(Node start, (int x, int y) moveTo)
        {
            if (_movementCost.TryGetValue((start.X, start.Y, moveTo.x, moveTo.y), out var moveCost))
            {
                var goal = new Node
                {
                    X = moveTo.x,
                    Y = moveTo.y,
                    Steps = start.Steps + moveCost
                };
                return goal;
            }
            
            HashSet<(int x, int y)> visited = new();
            var searchQueue = new Queue<Node>();
            
            searchQueue.Enqueue(start);
            visited.Add((start.X, start.Y));

            while (searchQueue.Count > 0)
            {
                var node = searchQueue.Dequeue();

                foreach (var child in node.AllPossibleMoves())
                {
                    if(visited.Add((child.X, child.Y)) == false)
                        continue;

                    if (moveTo == (child.X, child.Y))
                    {
                        _movementCost[(start.X, start.Y, moveTo.x, moveTo.y)] = child.Steps - start.Steps;
                        _movementCost[(moveTo.x, moveTo.y, start.X, start.Y)] = child.Steps - start.Steps;
                        return child;
                    }
                    searchQueue.Enqueue(child);
                }
            }

            throw new Exception($"Found no way to {moveTo}");
        }
        
        

        public class Node
        {
            public int X;
            public int Y;
            public int Steps;

            public Node()
            {
            }

            private Node(Node other, int dx, int dy)
            {
                X = other.X + dx;
                Y = other.Y + dy;
                Steps = other.Steps + 1;
            }

            public IEnumerable<Node> AllPossibleMoves()
            {
                if (X > 0 && _map[(X - 1, Y)] != '#')
                    yield return new Node(this, -1, 0);
                if (X <= _width && _map[(X + 1, Y)] != '#')
                    yield return new Node(this, 1, 0);
                if (Y > 0 && _map[(X, Y - 1)] != '#')
                    yield return new Node(this, 0, -1);
                if (Y <= _height && _map[(X, Y + 1)] != '#')
                    yield return new Node(this, 0, 1);
            }

        }
        
        private const string Test = @"###########
#0.1.....2#
#.#######.#
#4.......3#
###########";

        private const string Data = @"###################################################################################################################################################################################
#.........#...#.............#...#3#.#.....#...........#.........#.#...#.......#.#.#...#...#.................#...........#.#...#.#.......#.......#.......#...#...#.....#.....#.....#
#.#.#.#.#.#.#########.#.#.###.#.#.#.###.###.#.###.#.#.#.###.#.###.#.#.#.#.#####.#.#.#.#.#.#.###.#.#.#.#.#.#.#.###.#.#.###.#.#.#.#####.#.#.#.###.#.#.#.#.#.###.#.###.###.###.###.#.#
#...#...#...#.......#...#.#.#.....#...#.....#.........#.......#.#...#...#.#.............#...#.......#.#.#...#.#.....#.......#...#.....#...#...........#...#...#.#...............#2#
#.###.#.#.#####.###.###.#.#.#.#.###.#.#.#####.#######.#.###.###.#.#.#.#.#.#####.###.###.#.#.#####.#.###.#.###.#.#.#.#.#.#######.#######.#.#.###.###.###.#.#.#.#.#.#.###.#.###.#.###
#.......#.........#.#.#...#...#...#.....#.#.............#.....#...#.......#.#.....#...#...#.......#.............................#.#...#...#...#.....#...#.......#.......#.......#.#
#.###.#.#.#########.#.#.#.#.#.#.#.#.#.#.#.#.#.#.###.#.#.#####.#.#.#######.#.#.#.#.#.#.#####.#.###.#.#####.#.###.###.#.#.###.###.#.#.#.#####.#.###.#.#.#.#######.###.#.#.#.###.###.#
#...#.#...#...#...#...#.#...#.....#...#...........#.....#.........#.#...#...#...#.#...#.......#...#.#.....#.#.....#...#.#.......#.#.#.......#.......#...........#.#.#...#.#.......#
#.#.#.###.###.#.#.#######.#.#.#.#.#.#.###.###########.#.#.#####.###.#.#.#####.#.#.#.#####.###.#.###.#####.###.#####.#########.#.###.#.###.#.#.#.#.###.###.#.#####.#.#.#.#.#.###.#.#
#.......#.......#...........#...#.#...#.............#.#.#...#...#.....#...#...#.#...#...#.......#.#.#.#...#.....#.#.#.........#...#...#.....#.#...........#.#.......#.#.#...#...#.#
#.#.#.###.#####.#.#####.#.###.#.#.#.###.#.#.#.###.###.#.#####.###.#####.#.#.#####.#.#.#.#######.#.###.#.###.#####.#.#####.#.#.#####.#.#.#.#.###.#.#######.#.#.#.###########.#.#.#.#
#.#.#.....#.#1..........#.#...#...#.....#.........#...............#.#...#.....#...#.......#...........#.#...#.#.....#.............#.............#.....#...#.....#...#.....#.#.....#
#.#.###.#.#.#####.#.#.#.###.#####.#.#.#.###.###.#.#.#.#####.#.#.###.#.#.#####.#.#.#.#.#.#.###.#.###.#.#.#.#.#.#.###.#.#.#####.###.###.###.#.#.#.###.#.#.#.#.#.###.#.#.#####.#####.#
#...#...#.#...#.#.#.#.#.......#.....................#.#...............#.......#.#...#.#.#.....#.#.#...#...#.#.......#.....#.#...#.........#.#.#...#.........#.............#.....#.#
#.###.###.###.#.#.###.#.#####.#.#####.###.###########.###.#.#.#####.#.#.#.###.###.#.#.#.#.###.#.#.#.#.###.#.###.#.#########.#.#.#.#.###.#.#.#.#.#.#.#.#.#.###.###.#####.#.#####.###
#.....#.#.......#.#.#.....#...#.......#...#.#...#.............#.#.#.....#.........#...#.#.........#.#.#.#...#.#...#...#.......#.....#.#.....#.#.#.......#.#...#.#.....#.......#...#
#.#.###.#.#######.#.#.#.###.#.###.###.#####.#.#.#.#.###.###.###.#.#.#####.#.#####.#.#.#.#.#.#########.#.#.#.#.#.#.#.#.#.###.#.###.#.#.###.###.#.#######.#.#.#.#.#.###.#.#.#.#.###.#
#.#.#.......#...#...#.#.#.#.....#.....#...#...#.....#...#...#...#...........#...........#.........#.#.....#.....#.......#...#...#...#.#...#.#.#.........#...#.....#.#...#.#.....#.#
#.#.#.#####.#.#.#.###.###.#.#.#####.#.###.#.#.#####.#.#####.#.#.#.#####.###.#.#.#.#.###.#.#.#.#.#.#.#.###.#.#####.###.###.#.#.#.#.#.#.#.#.#.###.###.#.#######.#####.###.#.###.###.#
#.#.......#.#...#.#...#.#.#.......#...#.....#.........#.....#.#.....#...#...#.#.#...#.....#...#...#...#.....#.......#.#.#...#.#.........#...#.#..4#.#.#.#.#.....#.....#.........#.#
#.###.#.#.#.###.#.#.###.#.#######.#.#.###.#.###.#.#.#.#.#.#.###.#####.#.###.#######.#####.###.#.#.#.#.#.###.#.#####.#.#.#.#.#.#.#.#.#.#.#.#.#.#######.#.#.#.#.#.#.#.#.#.#.###.#.#.#
#0#...#.#.#.....#...#...#.#...#...#...#...#.......#.#.#.....#...#...#...#...#...#...#.........#.......#...#.......#...#...#...#.......#...#...............#.....#...#...#...#.#...#
###.#.#.###.###########.#.#####.###.###.###.###.###.#.###.#.#.#.#.#.#.#.#.#.#.###.#.###.#.#.#.#####.#.#.#.#.#.#.#.#.#.#.#.###.#####.#.#####.#.#.#.#####.#.#.#####.#####.#.#.#.#.###
#...#.#...#.......#...#...........#...#.....#...#...#.#.........#.....#.#...#.......#.....#.#.#.........#.........#...#.#.#...#.#.....#.....................#...............#.....#
###.#.#.#.#.#.###.#.#.#.#.#######.#.#.###.###.#.#.#####.###.###.###.###.#.#.#.#.#######.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.#.###.#.#####.###.#######.###.###.#.###.###.###.###.#.#.#
#...#.............#.#...........#.#.#.....#.....#.......#.#.....#...#.........#.....#.......#.....#...#.....#...#.......#...#...#.#.........#...#...........#.......#...#.......#.#
###.#.#########.#.#.#####.#.#.#.#.#.#.###.#.#######.#.#.#.#.#.#####.#.#.#.#####.#.#.#.#####.#######.#.#.#.#.#.#####.#.#.#.#####.#.#.###.#######.#######.#.#.###.#.#.#.#.#.#.###.#.#
#.#...............#.#.......#.....#.................#...#.#.#.......#...#.......#.#.#...#.#.......#...#.....#.....#...#.#.......#.#.#.....#.....#.....#.#...#.#...#...#.#...#.#.#.#
#.#.#.###.#.#.#.#.#.#.#.#.#.#########.#.#.#.#.#.#.#.#.#.#.#.###.#.#.#.###.#.#.#.#.#.###.#.#.###.#.#.###.###.#.#.#####.#####.#####.#.#.#.#.#.#.###.#.#.#.###.#.#.#.#.###.#.#.#.#####
#...#.#.....#...#.............#.#.#.#.........#.#...#.#.....#.......#...#.#.#.....#.......#...#...#...........#.....#.#.......#...#...#.#.........#...#...#.....#.......#...#.....#
###.#.#.#.#.#.#.###.#.###.#.###.#.#.#.#.###.#.###.#.#.#####.###.###.#.#.#.###.#.#.###.###.###.#.#.#.#.###.#####.###.#####.#.#.###.###.#####.#####.#.#.#######.###.###.###.#.#.#.#.#
#...#.#.....#.........#.......#.#...#.......#...#...#...........#.....#.......#...........#.......#...#...#.....#.....#...#.......#.#.#...#.#.....#.........#.....#...#.#...#.#...#
###.###.###.###.#.#####.###.#.#.#.#.#.###.###.###.###.#.#####.#.#.#.#.###.#.#.###.#.###.###.#.#.###.###.#.#.#.#.#.#.#.#.#.#.#.#.###.#.###.#.###.#.#.#####.#.#####.#.#.#.#####.#.#.#
#.#.#...#.#.#...................#.......#.#.#.#.#.....#.#.#.....#...#.......#.#...#.......#.....#...#.....#...#...#.#...#...#.........#...#...#...........#.........#.#..5#...#...#
#.#.#.###.#.###.#####.#.#.###.#.#####.#.#.#.#.#.#.###.#.#.#.#######.###.#.#.#.#.#.###.#.#.#.###.#.#####.#.#.#.#####.#.###.#.#.###.###.#.###.#.#.###########.#.#######.#.#.#.###.###
#...#.#.#...#.#.................#.#.....#.#.........#.....#.#.#...#.#.........#...#.#...#.#.........#...#...#.....#.#.#.#.....#...#.#.....#.#.............#.#...#.#.#.....#...#...#
#.#.###.#.#.#.#.#.#.#.#.###.###.#.#.#######.#######.###.#.#.#.###.#.#.#####.###.###.#####.#.#####.#.#.#.#.#.#.###.#.#.#.#.###.#.#.#.#.#.#.#.#####.#.#.#.#.###.#.#.#.#.#####.###.#.#
#...#.....#.....#.....#.#...#...#...............#...#...#...#.....#...#.#.....#.#.#...#...#.#...#...#.....#...#...#...................#.........#...#.........#.#...#.......#...#.#
###.#.###.#.#.#.###.#.#.#.#.#.###.###.#.###.###.#.###.#.#######.#.#.#.#.#.#####.#.#.#.#.#.###.#.#.#.#####.#.#.###.#.#######.#######.###.#######.#.#.#.#.###.###.###.#.#.#.#.#.#.#.#
#.....#7..#.#.#...........#.#...#.........#.....#.#.#...#.....#.............#...#...#...#.#.#...#.......#...#.....#.#.......#.#.....#...#...#...#...#...#...#.#.....#.#.......#.#.#
#.#.#.#.#.#.#.#.#.#.###.#####.#.#############.#.###.#.#.#.#.###.###.#######.#.#.###.#.###.#.###.#######.###.###.#.#.###.#.#.#.#.#.###.###.###.#.#.###.#.#.#.#.#.#.###.#.###.#.#.###
#...#.....#.#...#.#.....#.....#...#...#.......#6#.......#.#.......#.#.........#...#.#.....#.....#.#.......#.#.......#.......#.....#.....#.....#...#.#.#.#...#.#...#.#...#...#.#.#.#
###################################################################################################################################################################################";

    }
}